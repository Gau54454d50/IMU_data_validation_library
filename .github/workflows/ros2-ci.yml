name: ROS2 CI

on:
  push:
    paths:
      - '/**'
      - '.github/workflows/ros2-ci.yml'
  pull_request:
    paths:
      - '/**'
      - '.github/workflows/ros2-ci.yml'

jobs:
  build-and-test:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        build_type: [RelWithDebInfo, Release]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup ROS 2 Jazzy
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: jazzy

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-colcon-common-extensions

      - name: Resolve ROS dependencies (rosdep)
        run: |
          source /opt/ros/jazzy/setup.bash
          rosdep update
          rosdep install --from-paths / --ignore-src -r -y

      - name: Guard against invalid Vector3 brace-list assignment regressions
        run: |
          if rg -n "angular_velocity\s*=\s*\{|linear_acceleration\s*=\s*\{" IMU_data_validation_library/tests; then
            echo "Found invalid brace-list assignment to geometry_msgs::msg::Vector3 fields."
            exit 1
          fi

      - name: Create colcon workspace
        run: |
          mkdir -p ros_ws/src
          ln -sfn "${GITHUB_WORKSPACE}" ros_ws/src/IMU_data_validation_library

      - name: Build package (tests enabled)
        run: |
          source /opt/ros/jazzy/setup.bash
          cd ros_ws
          colcon build \
            --packages-select IMU_data_validation_library \
            --event-handlers console_direct+ \
            --cmake-args -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DBUILD_TESTING=ON

      - name: Run package tests
        run: |
          source /opt/ros/jazzy/setup.bash
          cd ros_ws
          colcon test \
            --packages-select IMU_data_validation_library \
            --event-handlers console_direct+ \
            --return-code-on-test-failure

      - name: Verify new IMU validation suites pass
        run: |
          source /opt/ros/jazzy/setup.bash
          cd ros_ws
          colcon test \
            --packages-select IMU_data_validation_library \
            --event-handlers console_direct+ \
            --return-code-on-test-failure \
            --ctest-args \
              -R "test_imu_validation_profiles_and_anomalies|test_time_sequence_and_rosbag_replay" \
              --output-on-failure

      - name: Assert new test result XMLs exist
        run: |
          cd ros_ws
          test -f build/IMU_data_validation_library/test_results/IMU_data_validation_library/test_imu_validation_profiles_and_anomalies.gtest.xml
          test -f build/IMU_data_validation_library/test_results/IMU_data_validation_library/test_time_sequence_and_rosbag_replay.gtest.xml

      - name: Show test results
        if: always()
        run: |
          source /opt/ros/jazzy/setup.bash
          cd ros_ws
          colcon test-result --all --verbose

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: imu-validator-test-results-${{ matrix.build_type }}
          path: |
            ros_ws/build/IMU_data_validation_library/Testing/**
            ros_ws/log/latest_test/**
          if-no-files-found: warn
